<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulaci√≥n Navegador - Pila y Cola</title>
  <style>
    body{font-family:Arial, Helvetica, sans-serif; margin:20px; color:#222}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .card{border:1px solid #ddd; border-radius:10px; padding:14px; min-width:280px; flex:1}
    button{padding:10px 12px; border:1px solid #bbb; background:#f7f7f7; border-radius:8px; cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    select{padding:10px; border-radius:8px; border:1px solid #bbb; min-width:260px}
    .muted{color:#666; font-size:14px}
    ul{margin:8px 0 0 18px}
    .pill{display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; background:#fafafa}
  </style>
</head>
<body>

  <h1>Simulaci√≥n navegador</h1>

  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div>
        <label for="webs"><b>Lista de webs:</b></label><br>
        <select id="webs">
          <option value="google">Google</option>
          <option value="wikipedia">Wikipedia</option>
          <option value="github">GitHub</option>
          <option value="openai">OpenAI</option>
          <option value="elpais">El Pa√≠s</option>
        </select>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="abrir">Abrir (selecci√≥n)</button>
        <button id="atras">‚¨Ö Atr√°s</button>
        <button id="adelante">Adelante ‚û°</button>
        <button id="limpiar">üßπ Limpiar historial</button>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #eee; margin:14px 0">

    <div>
      <div><b>Web actual:</b> <span id="actual" class="pill">‚Äî</span></div>
      <div style="margin-top:8px"><b>Saltos:</b> <span id="saltos" class="pill">0</span></div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <b>Historial atr√°s (PILA)</b>
      <ul id="histAtras"></ul>
    </div>

    <div class="card">
      <b>Historial adelante (PILA)</b>
      <ul id="histAdelante"></ul>
    </div>
  </div>

<script>
/* =======================
   PILA
   ======================= */
class Pila {
  #elementos;
  constructor() { this.#elementos = []; }
  push(elemento) { this.#elementos.push(elemento); }
  pop() { return this.isEmpty() ? null : this.#elementos.pop(); }
  isEmpty() { return this.#elementos.length === 0; }
  toArrayTopFirst() { return [...this.#elementos].reverse(); } // cima->base (para pintar)
  toArrayBaseFirst() { return [...this.#elementos]; }          // base->cima (para guardar)
  loadFromBaseFirst(arr) { this.#elementos = Array.isArray(arr) ? [...arr] : []; }
  clear() { this.#elementos = []; }
}

/* =======================
   COLA
   ======================= */
class Cola {
  #elementos;
  constructor() { this.#elementos = []; }
  enqueue(elemento) { this.#elementos.push(elemento); }
  dequeue() { return this.isEmpty() ? null : this.#elementos.shift(); }
  isEmpty() { return this.#elementos.length === 0; }
  toArray() { return [...this.#elementos]; }
  loadFromArray(arr) { this.#elementos = Array.isArray(arr) ? [...arr] : []; }
  clear() { this.#elementos = []; }
}

/* =======================
   ESTADO NAVEGADOR
   ======================= */
const pilaAtras = new Pila();
const colaAdelante = new Cola();
let webActual = null;

const sel = document.getElementById("webs");
const actualEl = document.getElementById("actual");
const saltosEl = document.getElementById("saltos");
const msgEl = document.getElementById("msg");
const ulAtras = document.getElementById("histAtras");
const ulAdelante = document.getElementById("histAdelante");

const btnAbrir = document.getElementById("abrir");
const btnAtras = document.getElementById("atras");
const btnAdelante = document.getElementById("adelante");
const btnLimpiar = document.getElementById("limpiar");

/* =======================
   PINTAR UI
   ======================= */
function render() {
  actualEl.textContent = webActual ?? "‚Äî";

  // PILA atr√°s
  ulAtras.innerHTML = "";
  const backItems = pilaAtras.toArrayTopFirst();
  if (backItems.length === 0) {
    const li = document.createElement("li");
    li.textContent = "(vac√≠o)";
    ulAtras.appendChild(li);
  } else {
    backItems.forEach(x => {
      const li = document.createElement("li");
      li.textContent = x;
      ulAtras.appendChild(li);
    });
  }

  // COLA adelante
  ulAdelante.innerHTML = "";
  const fwdItems = colaAdelante.toArray();
  if (fwdItems.length === 0) {
    const li = document.createElement("li");
    li.textContent = "(vac√≠o)";
    ulAdelante.appendChild(li);
  } else {
    fwdItems.forEach(x => {
      const li = document.createElement("li");
      li.textContent = x;
      ulAdelante.appendChild(li);
    });
  }

  btnAtras.disabled = pilaAtras.isEmpty();
  btnAdelante.disabled = colaAdelante.isEmpty();
}

/* =======================
   API
   ======================= */
async function pedirUrl(siteId){
  const res = await fetch(`contador.php?action=url&site=${encodeURIComponent(siteId)}`, {
    credentials: "include"
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Error URL");
  return data.url;
}

async function incrementarSaltos(){
  const res = await fetch(`contador.php?action=jump`, {
    method: "POST",
    credentials: "include"
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Error saltos");
  return data.jumps;
}

/* =======================
   GUARDAR / CARGAR ESTADO EN SERVIDOR (COOKIE)
   ======================= */

// guardado con peque√±o "debounce" para no spamear el servidor
let saveTimer = null;
function programarGuardadoEstado(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(guardarEstadoServidor, 150);
}

async function guardarEstadoServidor(){
  const payload = {
    actual: webActual,
    atras: pilaAtras.toArrayBaseFirst(),  // base->cima
    adelante: colaAdelante.toArray()      // frente->final
  };

  const res = await fetch(`contador.php?action=state_set`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
    credentials: "include"
  });

  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Error guardando estado");
}

async function cargarEstadoServidor(){
  const res = await fetch(`contador.php?action=state_get`, {
    credentials: "include"
  });

  const data = await res.json();
  if (!data.ok) return; // si no hay nada guardado, no pasa nada

  // Cargar saltos
  saltosEl.textContent = String(data.jumps ?? 0);

  // Cargar historiales + actual
  webActual = data.state?.actual ?? null;
  pilaAtras.loadFromBaseFirst(data.state?.atras ?? []);
  colaAdelante.loadFromArray(data.state?.adelante ?? []);

  render();
}

async function limpiarEstadoServidor(){
  const res = await fetch(`contador.php?action=state_clear`, {
    method: "POST",
    credentials: "include"
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Error limpiando servidor");
}

/* =======================
   NAVEGACI√ìN
   ======================= */
async function navegar(siteId, modo){
  // modo: manual | atras | adelante
  try{
    msgEl.textContent = "";

    // Si es manual: limpiar cola adelante
    if (modo === "manual") {
      colaAdelante.clear();
    }

    // 1) pedir URL al servidor
    const url = await pedirUrl(siteId);

    // 2) abrir popup
    window.open(url, "_blank", "noopener,noreferrer,width=1100,height=720");

    // 3) incrementar cookie saltos
    const jumps = await incrementarSaltos();
    saltosEl.textContent = String(jumps);

    webActual = siteId;
    render();

    // 4) guardar estado (historiales) en servidor
    programarGuardadoEstado();

  } catch(e) {
    msgEl.textContent = "‚ùå " + e.message;
  }
}

// Abrir selecci√≥n manual
btnAbrir.addEventListener("click", async () => {
  const chosen = sel.value;
  if (webActual !== null) pilaAtras.push(webActual);
  await navegar(chosen, "manual");
});

// Atr√°s (pila)
btnAtras.addEventListener("click", async () => {
  if (webActual === null) return;

  colaAdelante.enqueue(webActual);
  const prev = pilaAtras.pop();
  if (prev === null) return;

  await navegar(prev, "atras");
});

// Adelante (cola)
btnAdelante.addEventListener("click", async () => {
  if (webActual === null) return;

  pilaAtras.push(webActual);
  const next = colaAdelante.dequeue();
  if (next === null) return;

  await navegar(next, "adelante");
});

// Limpiar historial (cliente + servidor)
btnLimpiar.addEventListener("click", async () => {
  try{
    msgEl.textContent = "";

    // Cliente
    webActual = null;
    pilaAtras.clear();
    colaAdelante.clear();
    saltosEl.textContent = "0";
    render();

    // Servidor (cookies)
    await limpiarEstadoServidor();

    msgEl.textContent = "‚úÖ Historial limpiado (cliente + servidor).";
  } catch(e){
    msgEl.textContent = "‚ùå " + e.message;
  }
});

/* =======================
   ARRANQUE: recuperar sesi√≥n previa
   ======================= */
render();
cargarEstadoServidor();
</script>

</body>
</html>
